{% extends "base.html" %}

{% block title %}Chat - Kgoloko Chatroom{% endblock %}

{% block content %}
<div class="container-fluid chat-container p-0">
    <div class="row g-0 h-100">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar p-3">
            <div class="d-flex flex-column h-100">
                <div class="text-center mb-4">
                    <h4 class="text-primary-green">
                        <i class="fas fa-comments me-2"></i>Kgoloko school
                    </h4>
                    <p class="text-muted small">Welcome, {{ username }} ({{ role }})</p>
                </div>
                
                <div class="mb-4">
                    <h6 class="text-primary-green">Rooms</h6>
                    <div class="list-group">
                        {% for room in rooms %}
                        <a href="#" class="list-group-item list-group-item-action room-link" data-room="{{ room.name }}">
                            <i class="fas fa-door-open me-2"></i>{{ room.name }}
                            <small class="d-block text-muted">{{ room.description }}</small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Admin Panel Link -->
                {% if role == 'admin' %}
                <div class="mb-4">
                    <h6 class="text-primary-green">Admin</h6>
                    <div class="list-group">
                        <a href="{{ url_for('admin_users') }}" class="list-group-item list-group-item-action">
                            <i class="fas fa-users-cog me-2"></i>User Management
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <div class="mb-4">
                    <h6 class="text-primary-green">Online Users <span class="badge bg-primary-green" id="online-count">0</span></h6>
                    <div class="online-users" id="online-users-list">
                        <!-- Online users will be populated here -->
                    </div>
                </div>
                
                <div class="mt-auto">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('user_settings') }}" class="btn btn-outline-primary-green">
                            <i class="fas fa-cog me-2"></i>Settings
                        </a>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-md-9 col-lg-10">
            <div class="d-flex flex-column h-100">
                <div class="room-title d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                    <h5 class="mb-0" id="current-room">Select a room to start chatting</h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary text-white me-2" id="user-count">0 users</span>
                        <button class="btn btn-sm btn-outline-primary" id="search-toggle">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <div class="d-none p-2 bg-light border-bottom" id="search-box">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search messages..." id="search-input">
                        <button class="btn btn-primary" id="search-btn">Search</button>
                    </div>
                </div>
                
                <div class="chat-messages flex-grow-1 p-3" id="chat-messages" style="overflow-y: auto; background-color: #f8f9fa;">
                    <div class="text-center text-muted mt-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Select a room to start chatting</p>
                    </div>
                </div>
                
                <div class="p-3 border-top bg-white">
                    <form id="message-form" class="d-flex">
                        <input type="text" class="form-control me-2 message-input" placeholder="Type your message..." id="message-input" disabled>
                        
                        <!-- File upload button -->
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="file-upload-btn" disabled>
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <label class="dropdown-item" for="image-upload">
                                        <i class="fas fa-image me-2"></i>Image
                                    </label>
                                    <input type="file" id="image-upload" accept="image/*" class="d-none" disabled>
                                </li>
                                <li>
                                    <label class="dropdown-item" for="video-upload">
                                        <i class="fas fa-video me-2"></i>Video
                                    </label>
                                    <input type="file" id="video-upload" accept="video/*" class="d-none" disabled>
                                </li>
                                <li>
                                    <label class="dropdown-item" for="audio-upload">
                                        <i class="fas fa-microphone me-2"></i>Voice Record
                                    </label>
                                    <input type="file" id="audio-upload" accept="audio/*" class="d-none" disabled>
                                </li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="send-button" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    
                    <!-- Voice recording interface -->
                    <div class="mt-2 d-none" id="voice-recorder">
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-primary me-2" id="start-recording">
                                <i class="fas fa-microphone"></i> Start Recording
                            </button>
                            <button class="btn btn-outline-danger me-2 d-none" id="stop-recording">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <div id="recording-timer" class="text-muted">00:00</div>
                        </div>
                        <audio id="recorded-audio" class="mt-2 d-none" controls></audio>
                    </div>
                    
                    <!-- File preview -->
                    <div id="file-preview" class="mt-2 d-none">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span id="file-name">No file selected</span>
                                    <button type="button" class="btn-close" id="remove-file"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .sidebar {
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        height: 100vh;
        overflow-y: auto;
    }
    
    .room-link.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .room-link.active small {
        color: #e6e6e6 !important;
    }
    
    .message-bubble {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 18px;
        margin-bottom: 10px;
        position: relative;
    }
    
    .message-sent {
        background-color: #007bff;
        color: white;
        margin-left: auto;
    }
    
    .message-received {
        background-color: #e9ecef;
        color: #212529;
    }
    
    .message-time {
        font-size: 0.75rem;
        opacity: 0.8;
    }
    
    .online-indicator {
        width: 10px;
        height: 10px;
        background-color: #28a745;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .chat-messages {
        background-color: #f8f9fa;
    }
    
    .media-container {
        margin-top: 8px;
        max-width: 100%;
        position: relative;
    }
    
    .media-container img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .media-container video {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
    }
    
    .media-audio-player {
        width: 100%;
        margin-top: 8px;
        background-color: #f8f9fa;
        border-radius: 20px;
        padding: 10px;
    }
    
    .media-download-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 10;
    }
    
    .media-container:hover .media-download-btn {
        opacity: 1;
    }
    
    .audio-download-btn {
        position: relative;
        top: 0;
        right: 0;
        margin-left: 10px;
        opacity: 1;
    }
    
    .audio-controls {
        display: flex;
        align-items: center;
        margin-top: 8px;
    }
    
    .media-modal .modal-content {
        background-color: transparent;
        border: none;
    }
    
    .media-modal .modal-body {
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .media-modal img {
        max-width: 100%;
        max-height: 80vh;
    }
    
    .audio-fallback {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 20px;
        margin-top: 8px;
    }
    
    .audio-fallback button {
        margin-left: 10px;
    }
</style>

<!-- Modal for viewing images -->
<div class="modal fade media-modal" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <img src="" alt="Enlarged view" id="modal-image">
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="download-modal-image">
                    <i class="fas fa-download me-1"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chat interface loaded');
    
    // Chat functionality
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    const roomLinks = document.querySelectorAll('.room-link');
    const currentRoomElement = document.getElementById('current-room');
    const onlineUsersList = document.getElementById('online-users-list');
    const onlineCountElement = document.getElementById('online-count');
    const userCountElement = document.getElementById('user-count');
    const searchToggle = document.getElementById('search-toggle');
    const searchBox = document.getElementById('search-box');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const sendButton = document.getElementById('send-button');
    
    // File upload elements
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const imageUpload = document.getElementById('image-upload');
    const videoUpload = document.getElementById('video-upload');
    const audioUpload = document.getElementById('audio-upload');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const removeFileBtn = document.getElementById('remove-file');
    const voiceRecorder = document.getElementById('voice-recorder');
    const startRecordingBtn = document.getElementById('start-recording');
    const stopRecordingBtn = document.getElementById('stop-recording');
    const recordingTimer = document.getElementById('recording-timer');
    const recordedAudio = document.getElementById('recorded-audio');
    
    // Modal elements
    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    const modalImage = document.getElementById('modal-image');
    const downloadModalImageBtn = document.getElementById('download-modal-image');
    
    let currentRoom = null;
    let messagePolling = null;
    let currentUsername = "{{ username }}";
    let currentFile = null;
    let currentFileType = null;
    let currentModalImageUrl = null;
    
    // Function to load messages for a room
    function loadMessages(room) {
        console.log('Loading messages for room:', room);
        fetch(`/get_messages/${room}?limit=50`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(messages => {
                chatMessages.innerHTML = '';
                if (messages.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="text-center text-muted mt-5">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    `;
                } else {
                    messages.forEach(message => {
                        addMessageToChat(message);
                    });
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Add event listeners for media elements
                setTimeout(() => {
                    addMediaEventListeners();
                }, 100);
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                chatMessages.innerHTML = `
                    <div class="text-center text-muted mt-5">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Error loading messages. Please try again.</p>
                    </div>
                `;
            });
    }
    
    // Function to add a message to the chat
    function addMessageToChat(message) {
        const isCurrentUser = message.username === currentUsername;
        const messageClass = isCurrentUser ? 'message-sent' : 'message-received';
        
        const messageElement = document.createElement('div');
        messageElement.classList.add('message-bubble', messageClass);
        
        let messageContent = '';
        let mediaUrl = message.message || message.file_path || '';
        
        // Ensure media URLs have the correct path
        if (mediaUrl && !mediaUrl.startsWith('/') && !mediaUrl.startsWith('http') && !mediaUrl.startsWith('blob:')) {
            mediaUrl = '/' + mediaUrl;
        }
        
        // Handle different message types
        if (message.message_type === 'image') {
            messageContent = `
                <div class="media-container">
                    <img src="${mediaUrl}" alt="Shared image" class="img-fluid" data-media-url="${mediaUrl}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <button class="media-download-btn" data-media-url="${mediaUrl}" data-media-type="image">
                        <i class="fas fa-download"></i>
                    </button>
                    <div class="alert alert-warning mt-2 d-none">Image failed to load. <a href="${mediaUrl}" download>Download instead</a></div>
                </div>
            `;
        } else if (message.message_type === 'video') {
            messageContent = `
                <div class="media-container">
                    <video controls class="img-fluid" data-media-url="${mediaUrl}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                        <source src="${mediaUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <button class="media-download-btn" data-media-url="${mediaUrl}" data-media-type="video">
                        <i class="fas fa-download"></i>
                    </button>
                    <div class="alert alert-warning mt-2 d-none">Video failed to load. <a href="${mediaUrl}" download>Download instead</a></div>
                </div>
            `;
        } else if (message.message_type === 'audio') {
            messageContent = `
                <div class="media-container">
                    <audio controls class="media-audio-player" data-media-url="${mediaUrl}" onerror="handleAudioError(this)">
                        <source src="${mediaUrl}" type="audio/mpeg">
                        <source src="${mediaUrl}" type="audio/wav">
                        <source src="${mediaUrl}" type="audio/ogg">
                        Your browser does not support the audio element.
                    </audio>
                    <div class="audio-controls">
                        <button class="btn btn-sm btn-outline-primary media-download-btn audio-download-btn" data-media-url="${mediaUrl}" data-media-type="audio">
                            <i class="fas fa-download me-1"></i> Download
                        </button>
                    </div>
                    <div class="alert alert-warning mt-2 d-none">Audio failed to load. <a href="${mediaUrl}" download>Download instead</a></div>
                </div>
            `;
        } else {
            messageContent = `<div class="message-content">${escapeHtml(message.message)}</div>`;
        }
        
        messageElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-1">
                <strong>${isCurrentUser ? 'You' : escapeHtml(message.username)}</strong>
                <small class="message-time">${formatTime(message.timestamp)}</small>
            </div>
            ${messageContent}
        `;
        
        chatMessages.appendChild(messageElement);
    }
    
    // Handle audio errors
    function handleAudioError(audioElement) {
        console.error('Audio loading error:', audioElement.src);
        // Show fallback option
        const container = audioElement.closest('.media-container');
        const fallback = container.querySelector('.alert');
        if (fallback) {
            fallback.classList.remove('d-none');
        }
        
        // Try to fix the URL if it's incorrect
        if (audioElement.src && !audioElement.src.startsWith('http') && !audioElement.src.startsWith('/') && !audioElement.src.startsWith('blob:')) {
            audioElement.src = '/' + audioElement.src;
            audioElement.load();
        }
    }
    
    // Add event listeners for media elements
    function addMediaEventListeners() {
        // Image click to open modal
        document.querySelectorAll('.media-container img').forEach(img => {
            img.addEventListener('click', function() {
                const mediaUrl = this.getAttribute('data-media-url');
                if (mediaUrl) {
                    modalImage.src = mediaUrl;
                    currentModalImageUrl = mediaUrl;
                    imageModal.show();
                }
            });
        });
        
        // Download buttons
        document.querySelectorAll('.media-download-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const mediaUrl = this.getAttribute('data-media-url');
                const mediaType = this.getAttribute('data-media-type');
                if (mediaUrl) {
                    downloadMedia(mediaUrl, mediaType);
                }
            });
        });
        
        // Fix for audio players - ensure they're properly initialized
        document.querySelectorAll('audio').forEach(audio => {
            // Reset and reload the audio element to fix playback issues
            audio.load();
            
            // Add error handling
            audio.addEventListener('error', function() {
                handleAudioError(this);
            });
            
            // Add event listeners for audio playback
            audio.addEventListener('canplay', function() {
                console.log('Audio can play:', this.src);
            });
            
            audio.addEventListener('loadstart', function() {
                console.log('Audio loading started:', this.src);
            });
        });
    }
    
    // Function to download media
    function downloadMedia(url, type) {
        if (!url) {
            console.error('No URL provided for download');
            return;
        }
        
        // Create a temporary anchor element to trigger download
        const a = document.createElement('a');
        a.href = url;
        
        // Generate a filename with timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        a.download = `kgoloko_${type}_${timestamp}.${type === 'audio' ? 'mp3' : type}`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    // Helper function to format time
    function formatTime(timestamp) {
        try {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } catch (e) {
            return timestamp;
        }
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Function to update online users
    function updateOnlineUsers() {
        fetch('/get_online_users')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(users => {
                onlineUsersList.innerHTML = '';
                onlineCountElement.textContent = users.length;
                
                // Filter out current user from online users list
                const otherUsers = users.filter(user => user.username !== currentUsername);
                userCountElement.textContent = `${otherUsers.length + 1} users`; // +1 for current user
                
                // Add current user first
                const currentUserElement = document.createElement('div');
                currentUserElement.classList.add('d-flex', 'align-items-center', 'mb-2');
                currentUserElement.innerHTML = `
                    <span class="online-indicator"></span>
                    You ({{ role }})
                `;
                onlineUsersList.appendChild(currentUserElement);
                
                // Add other users
                otherUsers.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.classList.add('d-flex', 'align-items-center', 'mb-2');
                    userElement.innerHTML = `
                        <span class="online-indicator"></span>
                        ${escapeHtml(user.username)} <span class="badge bg-secondary ms-2">${user.role}</span>
                    `;
                    onlineUsersList.appendChild(userElement);
                });
            })
            .catch(error => {
                console.error('Error fetching online users:', error);
            });
    }
    
    // Handle room selection
    roomLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active room
            roomLinks.forEach(r => r.classList.remove('active'));
            this.classList.add('active');
            
            // Set current room
            currentRoom = this.dataset.room;
            const roomName = this.querySelector('i').nextSibling.textContent.trim();
            const roomDescription = this.querySelector('small').textContent;
            currentRoomElement.textContent = `${roomName} - ${roomDescription}`;
            
            // Enable message input
            messageInput.disabled = false;
            sendButton.disabled = false;
            
            // Enable file upload
            fileUploadBtn.disabled = false;
            imageUpload.disabled = false;
            videoUpload.disabled = false;
            audioUpload.disabled = false;
            
            // Load messages for the room
            loadMessages(currentRoom);
            
            // Start polling for new messages
            if (messagePolling) {
                clearInterval(messagePolling);
            }
            
            messagePolling = setInterval(() => {
                if (!currentRoom) return;
                
                fetch(`/get_messages/${currentRoom}?limit=1`)
                    .then(response => response.json())
                    .then(messages => {
                        if (messages.length > 0) {
                            const lastMessage = messages[messages.length - 1];
                            // Check if this message is already displayed
                            const existingMessages = chatMessages.querySelectorAll('.message-bubble');
                            const lastDisplayed = existingMessages[existingMessages.length - 1];
                            
                            if (!lastDisplayed || 
                                !lastDisplayed.querySelector('.message-time').textContent.includes(
                                    formatTime(lastMessage.timestamp))) {
                                addMessageToChat(lastMessage);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                
                                // Add event listeners for new media elements
                                addMediaEventListeners();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error polling for messages:', error);
                    });
            }, 3000);
        });
    });
    
    // Handle message submission
    messageForm.addEventListener('submit', function(e) {
    e.preventDefault();
    console.log('Submit button clicked');
    
    if (!currentRoom) {
        alert('Please select a room to send a message.');
        return;
    }
    
    if (messageInput.value.trim() === '' && !currentFile) {
        alert('Please enter a message or select a file.');
        return;
    }
    
    const formData = new FormData();
    formData.append('room', currentRoom);
    formData.append('message_type', currentFileType || 'text');
    
    if (currentFile) {
        formData.append('file', currentFile);
        if (messageInput.value.trim()) {
            formData.append('message', messageInput.value.trim());
        }
    } else {
        formData.append('message', messageInput.value.trim());
    }
    
    console.log('Sending message to server');
    
    fetch('/send_message', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Network response was not ok');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Server response:', data);
        if (data.status === 'success') {
            messageInput.value = '';
            if (currentFile) {
                clearFileSelection();
            }
            // Add the sent message to the chat immediately
            addMessageToChat(data);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            addMediaEventListeners();
        } else {
            alert('Error sending message: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Error sending message: ' + error.message);
    });
});
    
    // File upload handling
    function handleFileUpload(file, type) {
        currentFile = file;
        currentFileType = type;
        fileName.textContent = file.name;
        filePreview.classList.remove('d-none');
        
        // Enable submit button if there's a file
        sendButton.disabled = false;
    }
    
    function clearFileSelection() {
        currentFile = null;
        currentFileType = null;
        filePreview.classList.add('d-none');
        imageUpload.value = '';
        videoUpload.value = '';
        audioUpload.value = '';
        recordedAudio.classList.add('d-none');
        voiceRecorder.classList.add('d-none');
    }
    
    imageUpload.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            handleFileUpload(this.files[0], 'image');
        }
    });
    
    videoUpload.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            handleFileUpload(this.files[0], 'video');
        }
    });
    
    audioUpload.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            handleFileUpload(this.files[0], 'audio');
        }
    });
    
    removeFileBtn.addEventListener('click', clearFileSelection);
    
    // Voice recording functionality
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingInterval = null;
    let recordingSeconds = 0;
    
    startRecordingBtn.addEventListener('click', function() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = function(e) {
                        audioChunks.push(e.data);
                    };
                    
                    mediaRecorder.onstop = function() {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        currentFile = audioBlob;
                        currentFileType = 'audio';
                        fileName.textContent = 'Voice recording.wav';
                        filePreview.classList.remove('d-none');
                        
                        const audioURL = URL.createObjectURL(audioBlob);
                        recordedAudio.src = audioURL;
                        recordedAudio.classList.remove('d-none');
                        
                        // Enable submit button
                        sendButton.disabled = false;
                    };
                    
                    mediaRecorder.start();
                    startRecordingBtn.classList.add('d-none');
                    stopRecordingBtn.classList.remove('d-none');
                    
                    // Start timer
                    recordingSeconds = 0;
                    recordingInterval = setInterval(function() {
                        recordingSeconds++;
                        const minutes = Math.floor(recordingSeconds / 60);
                        const seconds = recordingSeconds % 60;
                        recordingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }, 1000);
                })
                .catch(function(err) {
                    console.error('Error accessing microphone:', err);
                    alert('Cannot access microphone. Please check permissions.');
                });
        } else {
            alert('Your browser does not support audio recording.');
        }
    });
    
    stopRecordingBtn.addEventListener('click', function() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            
            startRecordingBtn.classList.remove('d-none');
            stopRecordingBtn.classList.add('d-none');
            
            // Stop timer
            clearInterval(recordingInterval);
            recordingTimer.textContent = '00:00';
        }
    });
    
    // Toggle voice recorder
    document.querySelector('.dropdown-item[for="audio-upload"]').addEventListener('click', function(e) {
        e.preventDefault();
        voiceRecorder.classList.toggle('d-none');
    });
    
    // Toggle search box
    searchToggle.addEventListener('click', function() {
        searchBox.classList.toggle('d-none');
    });
    
    // Handle search
    searchBtn.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (query === '' || !currentRoom) return;
        
        fetch(`/search_messages?q=${encodeURIComponent(query)}&room=${currentRoom}`)
            .then(response => response.json())
            .then(results => {
                chatMessages.innerHTML = '';
                if (results.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="text-center text-muted mt-5">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <p>No results found for "${query}"</p>
                        </div>
                    `;
                } else {
                    results.forEach(message => {
                        addMessageToChat(message);
                    });
                    
                    // Add event listeners for media elements in search results
                    addMediaEventListeners();
                }
            })
            .catch(error => {
                console.error('Error searching messages:', error);
            });
    });
    
    // Download button in modal
    downloadModalImageBtn.addEventListener('click', function() {
        if (currentModalImageUrl) {
            downloadMedia(currentModalImageUrl, 'image');
        }
    });
    
    // Initial update of online users
    updateOnlineUsers();
    setInterval(updateOnlineUsers, 10000);
});
</script>
{% endblock %}